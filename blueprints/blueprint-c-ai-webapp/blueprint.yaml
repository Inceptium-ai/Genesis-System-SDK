# =============================================================================
# Blueprint C - AI Webapp
# =============================================================================
# A complete stack for building AI-powered web applications
# Updated: January 2, 2026 - V3 Schema with Components vs Integrations
# =============================================================================

name: blueprint-c-ai-webapp
version: 2.0.0
description: Production-ready AI-powered web application stack
validated: 2025-01-02
schema_version: "2.0"

# =============================================================================
# USE CASES
# =============================================================================
use_cases:
  - AI-powered document analysis
  - Resume optimization/review
  - Content generation applications
  - Chat interfaces with AI
  - AI assistants with user accounts
  - SaaS applications with AI features

# =============================================================================
# COMPONENTS - Generic building blocks (YOU own the code)
# =============================================================================
# Components are building blocks without specific protocols.
# They generate code that you fully control.
# =============================================================================
components:
  required:
    - name: fastapi-backend
      catalog: components/backend/fastapi-base
      purpose: Backend API with REST endpoints
      port: 8000
      
    - name: react-frontend
      catalog: components/frontend/react-vite-frontend
      purpose: Modern React SPA with TypeScript
      port: 5173
      
    - name: postgres
      catalog: components/database/postgres
      purpose: Relational database for user data, app state
      port: 5432
      
  optional:
    - name: redis
      catalog: components/database/redis
      purpose: Caching, rate limiting, session store
      port: 6379
      
    - name: file-extraction
      catalog: components/backend/file-extraction
      purpose: Extract text from PDF/DOCX files
      note: Use with resume upload features

# =============================================================================
# INTEGRATIONS - Third-party services (THEY own the protocol)
# =============================================================================
# Integrations are external services with defined protocols and behavior contracts.
# They require following specific protocols (OIDC, REST APIs, Webhooks, etc.)
# =============================================================================
integrations:
  required:
    - name: keycloak
      catalog: integrations/auth/keycloak
      purpose: Authentication, authorization, SSO via OIDC
      port: 8080
      behavior_contracts:
        - authorization_code_flow_pkce
        - backend_token_validation
        - multi_client_audience
        
  optional:
    - name: openai
      catalog: integrations/ai/openai
      purpose: LLM integration via OpenRouter/OpenAI API
      external: true
      behavior_contracts:
        - chat_completion
        - structured_output
      note: Use with AI features (roast, optimize, chat)

# =============================================================================
# STANDARD FEATURES
# =============================================================================
# Features that this blueprint enables out of the box
# Each feature points to components/integrations that provide it
# =============================================================================
features:
  - name: user_authentication
    description: Complete auth flow with OIDC (login, register, logout)
    provided_by:
      integration: keycloak
    behavior_contract: authorization_code_flow_pkce
    
  - name: protected_routes
    description: Frontend routes that require authentication
    provided_by:
      component: react-frontend
      integration: keycloak
      
  - name: api_authentication
    description: Backend validates JWT tokens from frontend
    provided_by:
      component: fastapi-backend
      integration: keycloak
    behavior_contract: backend_token_validation
    
  - name: user_data_persistence
    description: Store user-specific data in database
    provided_by:
      component: fastapi-backend
      component: postgres
      
  - name: ai_chat
    description: LLM-powered chat interface
    provided_by:
      component: fastapi-backend
      integration: openai
    optional: true
    
  - name: file_upload
    description: Upload and process files
    provided_by:
      component: fastapi-backend
      component: file-extraction
    optional: true

# =============================================================================
# ARCHITECTURE
# =============================================================================
architecture: |
  ┌─────────────────────────────────────────────────────────────────┐
  │                          FRONTEND                                │
  │  React + Vite + TypeScript + Tailwind + keycloak-js             │
  │  Port: 5173                                                      │
  └───────────────────────────┬─────────────────────────────────────┘
                              │ REST + Bearer Token
                              ▼
  ┌─────────────────────────────────────────────────────────────────┐
  │                    FASTAPI BACKEND                               │
  │  Port: 8000                                                      │
  │  - JWT validation via Keycloak JWKS                              │
  │  - LLM calls via OpenRouter                                      │
  │  - Business logic + data persistence                             │
  └──────┬──────────────┬──────────────┬───────────────────────────┘
         │              │              │
         ▼              ▼              ▼
  ┌──────────┐   ┌──────────┐   ┌──────────────────┐
  │ Postgres │   │ Keycloak │   │   OpenRouter     │
  │  (data)  │   │  (auth)  │   │  (LLM provider)  │
  └──────────┘   └──────────┘   └──────────────────┘

# =============================================================================
# WIRING - How components and integrations connect
# =============================================================================
wiring:
  frontend_to_keycloak:
    protocol: OIDC
    library: keycloak-js
    flow: Authorization Code with PKCE
    see_contract: integrations/auth/keycloak → authorization_code_flow_pkce
    
  frontend_to_backend:
    protocol: HTTP/REST
    auth: Bearer token (from Keycloak)
    
  backend_to_keycloak:
    protocol: HTTPS
    purpose: Fetch JWKS for token validation
    url: "{KEYCLOAK_URL}/realms/{realm}/protocol/openid-connect/certs"
    see_contract: integrations/auth/keycloak → backend_token_validation
    
  backend_to_llm:
    provider: openrouter
    protocol: HTTPS
    models:
      - anthropic/claude-haiku-4.5  # Fast, cheap (~$0.002/request)
      - anthropic/claude-sonnet-4   # Balanced
      - openai/gpt-4o               # Alternative
      
  backend_to_database:
    protocol: PostgreSQL
    pooling: SQLAlchemy async

# =============================================================================
# ENVIRONMENT VARIABLES
# =============================================================================
environment:
  # Secrets (required)
  required:
    - name: OPENROUTER_API_KEY
      description: API key from openrouter.ai
      obtain: https://openrouter.ai/keys
      
    - name: KEYCLOAK_ADMIN_PASSWORD
      description: Keycloak admin password
      
    - name: POSTGRES_PASSWORD
      description: Database password
      
  # Configuration (have defaults)
  recommended:
    - name: APP_NAME
      description: Application name (used in container names)
      default: myapp
      
    - name: KEYCLOAK_REALM
      description: Keycloak realm name
      default: ${APP_NAME}
      
    - name: FRONTEND_CLIENT_ID
      description: Keycloak frontend client
      default: ${APP_NAME}-frontend
      
    - name: BACKEND_CLIENT_ID
      description: Keycloak backend client
      default: ${APP_NAME}-backend
      
  optional:
    - name: OPENROUTER_MODEL
      description: Default LLM model
      default: anthropic/claude-haiku-4.5

# =============================================================================
# QUICK START
# =============================================================================
quick_start:
  steps:
    - step: 1
      description: Create project from blueprint
      command: genesis init --blueprint blueprint-c-ai-webapp --name myapp
      
    - step: 2
      description: Configure secrets
      command: |
        cp .env.example .env
        # Edit .env with your API keys
        
    - step: 3
      description: Start all services
      command: docker compose up -d
      
    - step: 4
      description: Initialize Keycloak
      command: ./scripts/init-keycloak.sh
      
    - step: 5
      description: Access application
      urls:
        frontend: http://localhost:5173
        backend_api: http://localhost:8000/docs
        keycloak_admin: http://localhost:8080/admin

# =============================================================================
# AWS DEPLOYMENT
# =============================================================================
aws_deployment:
  architecture:
    frontend: S3 + CloudFront
    backend: ECS Fargate
    database: RDS PostgreSQL
    auth: ECS Fargate (Keycloak) or Amazon Cognito
    secrets: AWS Secrets Manager
    
  estimated_cost:
    development: $30-60/month
    production: $150-400/month
    
  services:
    - name: frontend
      service: S3 + CloudFront
      purpose: Static hosting with CDN
      
    - name: api
      service: ECS Fargate
      cpu: 256
      memory: 512
      desired_count: 2
      
    - name: keycloak
      service: ECS Fargate
      cpu: 512
      memory: 1024
      note: Can migrate to Amazon Cognito for managed auth
      
    - name: database
      service: RDS PostgreSQL
      instance: db.t3.micro (dev) / db.t3.small (prod)

# =============================================================================
# GOTCHAS - LESSONS LEARNED
# =============================================================================
gotchas:
  keycloak:
    - See integrations/auth/keycloak/integration.yaml for all auth gotchas
    - Key issues: issuer mismatch, audience config, Docker networking
    
  local_development:
    - issue: Port conflicts on macOS
      solution: Use lsof -i :PORT before starting, use non-standard ports
      
    - issue: CORS errors
      solution: Use allow_origins=["*"] in dev, restrict in production
      
  llm_integration:
    - issue: API key not passed to Docker
      solution: Ensure OPENROUTER_API_KEY is in .env and docker-compose
      
    - issue: Rate limiting
      solution: Implement backoff, use redis for rate limit tracking

# =============================================================================
# FILES GENERATED
# =============================================================================
files:
  - docker-compose.yml          # Full stack orchestration
  - .env.example                 # Environment template
  - scripts/init-keycloak.sh    # Keycloak initialization (from integration)
  - backend/                     # FastAPI backend
  - frontend/                    # React frontend
  - config/keycloak/            # Realm configuration

# =============================================================================
# VERSION HISTORY
# =============================================================================
version_history:
  - version: 2.0.0
    date: 2025-01-02
    changes:
      - Separated components from integrations
      - Added behavior contracts reference for auth
      - Added standard features metadata
      - Updated to V3 schema

  - version: 1.0.0
    date: 2024-12-13
    changes:
      - Initial blueprint
